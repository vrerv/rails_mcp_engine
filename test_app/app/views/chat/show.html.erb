<div class="chat-container">
  <div class="chat-header">
    <h2>Chat with LLM</h2>
    <div class="chat-controls">
      <div class="control-group">
        <label for="model-select">Model:</label>
        <select id="model-select">
          <% @models.each do |model| %>
            <option value="<%= model %>" <%= 'selected' if model == 'gpt-4o' %>><%= model %></option>
          <% end %>
        </select>
      </div>
      <div class="control-group">
        <span class="tools-count"><%= @tools.length %> tools available</span>
      </div>
      <div class="control-group">
        <button id="clear-chat-button" onclick="clearConversation()" class="clear-button">Clear Chat</button>
      </div>
    </div>
  </div>

  <div class="chat-messages" id="chat-messages">
    <div class="welcome-message">
      <h3>Welcome to LLM Chat Testing</h3>
      <p>This interface allows you to chat with OpenAI models using all registered tools.</p>
      <p><strong>Available tools:</strong></p>
      <ul>
        <% @tools.each do |tool| %>
          <li><code><%= tool[:name] %></code> - <%= tool[:description] %></li>
        <% end %>
      </ul>
      <p>Select a model and start chatting!</p>
    </div>
  </div>

  <div class="chat-input-container">
    <textarea id="chat-input" placeholder="Type your message..." rows="3"></textarea>
    <div class="button-row">
      <button id="send-button" onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
let conversationHistory = [];

// Load conversation history from localStorage on page load
document.addEventListener('DOMContentLoaded', () => {
  // Restore conversation history
  const savedHistory = localStorage.getItem('chat_conversation_history');
  if (savedHistory) {
    try {
      conversationHistory = JSON.parse(savedHistory);
      // Restore messages to UI
      conversationHistory.forEach(msg => {
        addMessageToUI(msg.role, msg.content);
      });
    } catch (e) {
      console.error('Failed to load conversation history:', e);
      conversationHistory = [];
    }
  }

  // Send on Enter (Shift+Enter for new line)
  document.getElementById('chat-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
});

function sendMessage() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  const model = document.getElementById('model-select').value;

  if (!message) return;

  // Clear input
  input.value = '';

  // Add user message to UI
  addMessageToUI('user', message);

  // Disable send button
  const sendButton = document.getElementById('send-button');
  sendButton.disabled = true;
  sendButton.textContent = 'Sending...';

  // Send to server
  fetch('<%= chat_send_path %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({
      message: message,
      model: model,
      conversation_history: JSON.stringify(conversationHistory)
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      addMessageToUI('error', data.error);
    } else {
      conversationHistory = data.conversation_history;
      
      // Save to localStorage
      localStorage.setItem('chat_conversation_history', JSON.stringify(conversationHistory));

      // Display tool results if any
      if (data.tool_results && data.tool_results.length > 0) {
        data.tool_results.forEach(toolResult => {
          addToolResultToUI(toolResult);
        });
      }

      // Display final assistant message
      const lastMessage = conversationHistory[conversationHistory.length - 1];
      if (lastMessage && lastMessage.role === 'assistant') {
        addMessageToUI('assistant', lastMessage.content);
      }
    }
  })
  .catch(error => {
    addMessageToUI('error', 'Network error: ' + error.message);
  })
  .finally(() => {
    sendButton.disabled = false;
    sendButton.textContent = 'Send';
  });
}

function addMessageToUI(role, content) {
  const messagesContainer = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message message-${role}`;

  const roleLabel = document.createElement('div');
  roleLabel.className = 'message-role';
  roleLabel.textContent = role === 'user' ? 'You' : role === 'assistant' ? 'Assistant' : 'Error';

  const contentDiv = document.createElement('div');
  contentDiv.className = 'message-content';
  contentDiv.textContent = content || '(no content)';

  messageDiv.appendChild(roleLabel);
  messageDiv.appendChild(contentDiv);
  messagesContainer.appendChild(messageDiv);

  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addToolResultToUI(toolResult) {
  const messagesContainer = document.getElementById('chat-messages');
  const toolDiv = document.createElement('div');
  toolDiv.className = 'message message-tool';

  const toolHeader = document.createElement('div');
  toolHeader.className = 'tool-header';
  toolHeader.innerHTML = `<strong>ðŸ”§ Tool Call:</strong> <code>${toolResult.name}</code>`;

  const toolContent = document.createElement('div');
  toolContent.className = 'tool-content';

  const argsDiv = document.createElement('div');
  argsDiv.innerHTML = `<strong>Arguments:</strong> <pre>${JSON.stringify(toolResult.arguments, null, 2)}</pre>`;

  const resultDiv = document.createElement('div');
  resultDiv.innerHTML = `<strong>Result:</strong> <pre>${toolResult.content}</pre>`;

  toolContent.appendChild(argsDiv);
  toolContent.appendChild(resultDiv);

  toolDiv.appendChild(toolHeader);
  toolDiv.appendChild(toolContent);
  messagesContainer.appendChild(toolDiv);

  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function clearConversation() {
  if (confirm('Clear all conversation history?')) {
    conversationHistory = [];
    localStorage.removeItem('chat_conversation_history');
    
    // Clear UI - remove all messages except welcome message
    const messagesContainer = document.getElementById('chat-messages');
    const messages = messagesContainer.querySelectorAll('.message');
    messages.forEach(msg => msg.remove());
  }
}
</script>

<style>
.chat-container {
  height: calc(100vh - 8rem);
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.chat-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
  border-radius: 12px 12px 0 0;
}

.chat-header h2 {
  margin: 0 0 0.75rem 0;
  font-size: 1.25rem;
}

.chat-controls {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  align-items: center;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.control-group label {
  font-size: 0.9rem;
  font-weight: 500;
  color: #374151;
}

.control-group select {
  padding: 0.4rem 0.6rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.9rem;
}

.tools-count {
  font-size: 0.85rem;
  color: #6b7280;
  padding: 0.4rem 0.8rem;
  background: #eef2ff;
  border-radius: 6px;
}

.clear-button {
  padding: 0.4rem 0.8rem;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}

.clear-button:hover {
  background: #dc2626;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  background: #ffffff;
}

.welcome-message {
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 8px;
  padding: 1.5rem;
  color: #0c4a6e;
}

.welcome-message h3 {
  margin-top: 0;
  color: #0369a1;
}

.welcome-message ul {
  margin: 0.5rem 0;
}

.welcome-message code {
  background: #e0f2fe;
  padding: 0.15rem 0.4rem;
  border-radius: 3px;
  font-size: 0.9rem;
}

.message {
  margin-bottom: 1.5rem;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-role {
  font-weight: 600;
  font-size: 0.85rem;
  margin-bottom: 0.5rem;
  color: #6b7280;
}

.message-user .message-role {
  color: #3730a3;
}

.message-assistant .message-role {
  color: #059669;
}

.message-error .message-role {
  color: #dc2626;
}

.message-content {
  background: #f3f4f6;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  line-height: 1.6;
  white-space: pre-wrap;
}

.message-user .message-content {
  background: #eef2ff;
  color: #1e1b4b;
}

.message-assistant .message-content {
  background: #f0fdf4;
  color: #14532d;
}

.message-error .message-content {
  background: #fef2f2;
  color: #7f1d1d;
}

.message-tool {
  background: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
}

.tool-header {
  margin-bottom: 0.75rem;
  color: #78350f;
}

.tool-header code {
  background: #fef3c7;
  padding: 0.15rem 0.5rem;
  border-radius: 4px;
}

.tool-content {
  font-size: 0.9rem;
}

.tool-content pre {
  background: #fefce8;
  padding: 0.5rem;
  border-radius: 4px;
  overflow-x: auto;
  margin: 0.25rem 0;
  font-size: 0.85rem;
}

.chat-input-container {
  padding: 1rem 1.5rem;
  border-top: 1px solid #e5e7eb;
  background: #f9fafb;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  border-radius: 0 0 12px 12px;
}

.button-row {
  display: flex;
  justify-content: flex-end;
  width: 100%;
}


#chat-input {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.95rem;
  resize: none;
  box-sizing: border-box;
}

#chat-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#send-button {
  padding: 0.75rem 1.5rem;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

#send-button:hover:not(:disabled) {
  background: #2563eb;
}

#send-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}
</style>
